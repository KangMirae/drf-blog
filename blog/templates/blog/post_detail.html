<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê¸€ ìƒì„¸ë³´ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">
    <h1 class="mb-4">ğŸ“ ê¸€ ìƒì„¸ë³´ê¸°</h1>
    <div id="post-detail" class="mb-3"></div>
    <hr>
    <h4 class="mt-4">ğŸ’¬ ëŒ“ê¸€</h4>

    <ul id="comment-list" class="list-group mb-4"></ul>

    {% if user.is_authenticated %}
    <form id="comment-form">
        <div class="mb-3">
            <textarea id="comment-input" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">ëŒ“ê¸€ ì‘ì„±</button>
    </form>
    {% else %}
    <p class="text-muted">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
    {% endif %}

    <a href="/" class="btn btn-outline-primary">â† ëª©ë¡ìœ¼ë¡œ</a>

    <script>
        const postId = {{ post_id }};
        fetch(`/api/posts/${postId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('ê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                }
                return response.json();
            })
            .then(post => {
                const container = document.getElementById('post-detail');
                container.innerHTML = `
                    <h2>${post.title}</h2>
                    <p class="text-muted">ì‘ì„±ì: ${post.author}</p>
                    <hr>
                    <p>${post.content.replace(/\n/g, '<br>')}</p>
                    <div id="action-buttons" class="mt-3" style="display: none;">
                        <a href="#" id="edit-button" class="btn btn-warning btn-sm">ìˆ˜ì •</a>
                        <button id="delete-button" class="btn btn-danger btn-sm">ì‚­ì œ</button>
                    </div>
                `;
    
                // ë¡œê·¸ì¸ ìœ ì €ì™€ ì‘ì„±ì ì¼ì¹˜ ì‹œ ë²„íŠ¼ í‘œì‹œ
                if (post.author === "{{ user.username }}") {
                    document.getElementById('action-buttons').style.display = 'block';
    
                    // â— ë²„íŠ¼ì´ ìƒì„±ëœ ì´í›„ì— ì´ë²¤íŠ¸ ì—°ê²°í•´ì•¼ í•¨
                    document.getElementById('delete-button').addEventListener('click', () => {
                        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            fetch(`/api/posts/${postId}/`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                }
                            }).then(response => {
                                if (response.status === 204) {
                                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                    window.location.href = '/';
                                } else {
                                    alert('ì‚­ì œ ì‹¤íŒ¨');
                                }
                            });
                        }
                    });

                    document.getElementById('edit-button').addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.href = `/post/${postId}/edit/`;
                    });

                }
            })
            .catch(error => {
                document.getElementById('post-detail').innerText = 'ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                console.error(error);
            });
        

            function loadComments() {
                fetch(`/api/posts/${postId}/comments/`)
                    .then(res => res.json())
                    .then(data => {
                        const list = document.getElementById('comment-list');
                        list.innerHTML = '';
                        if (data.length === 0) {
                            list.innerHTML = '<li class="list-group-item text-muted">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                        } else {
                            data.forEach(comment => {
                                const li = document.createElement('li');
                                li.className = 'list-group-item';
                                li.innerHTML = `
                                    <div class="p-3 bg-light rounded shadow-sm mb-2">
                                        <div class="d-flex justify-content-between">
                                            <strong>${comment.author}</strong>
                                            <small class="text-muted">${comment.created_display}</small>
                                        </div>
                                        <div class="mt-2">${comment.content.replace(/\n/g, "<br>")}</div>
                                    </div>
                                `;                                list.appendChild(li);
                            });
                        }
                    });
            }

            // ëŒ“ê¸€ ì‘ì„±
            const form = document.getElementById('comment-form');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const content = document.getElementById('comment-input').value.trim();
                    if (!content) return;

                    fetch(`/api/posts/${postId}/comments/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ content })
                    }).then(res => {
                        if (res.ok) {
                            document.getElementById('comment-input').value = '';
                            loadComments();  // ëª©ë¡ ê°±ì‹ 
                        } else {
                            alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨");
                        }
                    });
                });
            }

            // ì´ˆê¸° ëŒ“ê¸€ ë¡œë”©
            loadComments();

    </script>
    
</body>
</html>
